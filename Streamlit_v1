import streamlit as st
import random
from datetime import datetime

# =========================
# Page Config
# =========================
st.set_page_config(
    page_title="ê³ ë ¹ì ë‚™ìƒ ì˜ˆë°© ê´€ì œ ì‹œìŠ¤í…œ",
    layout="wide"
)

TARGET_GU = "ë…¸ì›êµ¬"

st.title(f"â„ï¸ {TARGET_GU} ê³ ë ¹ì ë‚™ìƒ ì˜ˆë°© ê´€ì œ ì‹œìŠ¤í…œ")
st.caption("ë°˜ë³µ ìœ„í—˜ íŒ¨í„´ ê¸°ë°˜ ì‚¬ì „ ì˜ˆë°© ê´€ì œ Â· í–‰ì •ë™ ë‹¨ìœ„ íŒŒì¼ëŸ¿")

# =========================
# Session State
# =========================
if "level" not in st.session_state:
    st.session_state.level = "dong"   # dong â†’ cctv

if "selected_dong" not in st.session_state:
    st.session_state.selected_dong = None

if "seed" not in st.session_state:
    st.session_state.seed = 42

random.seed(st.session_state.seed)

# =========================
# Sidebar (View Control)
# =========================
st.sidebar.header("âš™ï¸ í™”ë©´ ì„¤ì •")

show_environment = st.sidebar.checkbox("í™˜ê²½ ì •ë³´ í‘œì‹œ", value=True)
show_heatmap = st.sidebar.checkbox("íˆíŠ¸ë§µ í‘œì‹œ", value=True)
show_list = st.sidebar.checkbox("í–‰ì •ë™ ëª©ë¡ í‘œì‹œ", value=True)

st.sidebar.divider()

risk_filter = st.sidebar.radio(
    "ì¡°ì¹˜ ìš°ì„ ë„ ê¸°ì¤€",
    ["ì „ì²´", "High", "Medium", "Low"]
)

st.sidebar.divider()

time_window = st.sidebar.radio(
    "ëˆ„ì  ê¸°ì¤€",
    ["ìµœê·¼ 4ì‹œê°„", "ìµœê·¼ 24ì‹œê°„", "ìµœê·¼ 72ì‹œê°„"]
)

# =========================
# ê³µí†µ í•¨ìˆ˜
# =========================
def priority_color(level: str) -> str:
    return {
        "High": "#ffdddd",
        "Medium": "#fff3cd",
        "Low": "#e6f4ea"
    }.get(level, "#f8f9fa")


def priority_label(score: int) -> str:
    if score >= 70:
        return "High"
    elif score >= 40:
        return "Medium"
    else:
        return "Low"


def goto(level: str, dong=None):
    st.session_state.level = level
    st.session_state.selected_dong = dong
    st.rerun()


def render_environment_info():
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("ğŸŒ¡ í˜„ì¬ ê¸°ì˜¨", "-3.2Â°C")
    with col2:
        st.metric("â° í˜„ì¬ ì‹œê°", datetime.now().strftime("%H:%M"))
    with col3:
        st.metric("ğŸŒ¨ ìµœê·¼ 24ì‹œê°„ ê°•ì„¤ëŸ‰", "6.5 cm")


def render_heatmap():
    st.subheader("ğŸ—ºï¸ í–‰ì •ë™ ë‹¨ìœ„ ëˆ„ì  ìœ„í—˜ íˆíŠ¸ë§µ")
    st.image("dong_hitmap.png", use_column_width=True)

    # í˜„ì¬ ì ìš© ì¤‘ì¸ ì¡°ê±´ ëª…ì‹œ
    st.caption(
        f"í˜„ì¬ ì ìš© ì¤‘ì¸ ì¡°ê±´ Â· "
        f"ì¡°ì¹˜ ìš°ì„ ë„: {risk_filter} Â· "
        f"ëˆ„ì  ê¸°ì¤€: {time_window}"
    )


def render_risk_legend():
    st.markdown(
        """
        <div style="display:flex; gap:24px; font-size:14px;">
            <div>ğŸŸ¥ <b>High</b> : ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”</div>
            <div>ğŸŸ¨ <b>Medium</b> : ì§€ì† ê´€ì°°</div>
            <div>ğŸŸ© <b>Low</b> : í˜„ì¬ ì•ˆì •</div>
        </div>
        """,
        unsafe_allow_html=True
    )

# =========================
# ë”ë¯¸ ë°ì´í„°
# =========================
dong_list = ["ìƒê³„ë™", "ì¤‘ê³„ë™", "í•˜ê³„ë™", "ì›”ê³„ë™", "ê³µë¦‰ë™"]

# =========================
# View: í–‰ì •ë™ (ì´ˆê¸° í™”ë©´)
# =========================
def render_dong_view():
    st.subheader(f"ğŸ˜ï¸ {TARGET_GU} í–‰ì •ë™ ì¡°ì¹˜ ìš°ì„  í˜„í™©")

    if show_environment:
        render_environment_info()
        st.divider()

    if show_heatmap:
        render_heatmap()
        render_risk_legend()
        st.divider()

    if show_list:
        st.markdown("### âš ï¸ ì¡°ì¹˜ ìš°ì„  í–‰ì •ë™ ëª©ë¡")

        dong_scores = {d: random.randint(30, 95) for d in dong_list}
        sorted_dongs = sorted(dong_list, key=lambda d: dong_scores[d], reverse=True)

        for dong in sorted_dongs:
            score = dong_scores[dong]
            priority = priority_label(score)

            if risk_filter != "ì „ì²´" and priority != risk_filter:
                continue

            st.markdown(
                f"""
                <div style="
                    padding:14px;
                    border-radius:12px;
                    background-color:{priority_color(priority)};
                    margin-bottom:10px;
                ">
                    <b>{dong}</b><br>
                    ì¡°ì¹˜ ìš°ì„ ë„: <b>{priority}</b><br>
                    <span style="font-size:12px; color:#555;">
                        (ë‚´ë¶€ ìœ„í—˜ ì§€í‘œ: {score})
                    </span>
                </div>
                """,
                unsafe_allow_html=True
            )

            if st.button(f"{dong} CCTV í˜„í™© ë³´ê¸°", key=f"btn_{dong}"):
                goto("cctv", dong=dong)

# =========================
# View: CCTV
# =========================
def render_cctv_view():
    st.subheader(f"ğŸ“¹ {TARGET_GU} / {st.session_state.selected_dong} CCTV í˜„í™©")

    if st.button("â† í–‰ì •ë™ìœ¼ë¡œ ëŒì•„ê°€ê¸°"):
        goto("dong")

    st.caption("â€» CCTVëŠ” ì¡°ì¹˜ íŒë‹¨ì˜ ê·¼ê±°ë¥¼ ì œê³µí•˜ëŠ” ì„¼ì„œ ë‹¨ìœ„ ì •ë³´ì…ë‹ˆë‹¤.")

    for i in range(1, 6):
        event_count = random.randint(0, 5)
        priority = "High" if event_count >= 3 else "Medium" if event_count >= 1 else "Low"

        if risk_filter != "ì „ì²´" and priority != risk_filter:
            continue

        st.markdown(
            f"""
            <div style="
                padding:14px;
                border-radius:12px;
                background-color:#f8f9fa;
                border:1px solid #ddd;
                margin-bottom:10px;
            ">
                <b>CCTV #{i}</b><br>
                ìµœê·¼ ìœ„í—˜ ì´ë²¤íŠ¸ ìˆ˜: {event_count}<br>
                ì¡°ì¹˜ ìš°ì„ ë„: <b>{priority}</b>
            </div>
            """,
            unsafe_allow_html=True
        )

# =========================
# Main Render
# =========================
if st.session_state.level == "dong":
    render_dong_view()
elif st.session_state.level == "cctv":
    render_cctv_view()

# =========================
# Footer
# =========================
st.divider()
st.info(
    """
    ë³¸ ì‹œìŠ¤í…œì€ **ë…¸ì¸ ì¸êµ¬ ë¹„ìœ¨ì´ ë†’ì€ ì§€ì—­ì„ ëŒ€ìƒìœ¼ë¡œ**,  
    ë°˜ë³µ ìœ„í—˜ íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ **í–‰ì • ì¡°ì¹˜ ìš°ì„ ìˆœìœ„ë¥¼ íŒë‹¨**í•˜ê¸° ìœ„í•œ  
    ê³ ë ¹ì ë‚™ìƒ ì‚¬ê³  ì‚¬ì „ ì˜ˆë°© ê´€ì œ ì†”ë£¨ì…˜ì…ë‹ˆë‹¤.
    """
)
